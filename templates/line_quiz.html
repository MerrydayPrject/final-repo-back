<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¼ì¸ í€´ì¦ˆ í…ŒìŠ¤íŠ¸ - Marryday</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .header-stats {
            position: absolute;
            top: 20px;
            right: 30px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px 25px;
            display: flex;
            gap: 30px;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .header-stats:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .header-stat-item {
            text-align: center;
        }

        .header-stat-value {
            font-size: 1.8em;
            font-weight: bold;
            display: block;
        }

        .header-stat-label {
            font-size: 0.85em;
            opacity: 0.9;
            margin-top: 5px;
        }

        .content {
            padding: 30px;
        }

        .stats-bar {
            display: flex;
            justify-content: space-around;
            background: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        .quiz-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .image-section {
            background: #f9f9f9;
            border-radius: 15px;
            padding: 20px;
        }

        .image-section h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .quiz-image {
            width: 100%;
            max-height: 500px;
            object-fit: contain;
            border-radius: 10px;
            background: white;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 15px;
        }

        .answer-section {
            background: #f9f9f9;
            border-radius: 15px;
            padding: 20px;
        }

        .answer-section h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .line-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .line-btn {
            padding: 20px;
            border: 3px solid #ddd;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
        }

        .line-btn:hover {
            border-color: #667eea;
            background: #f0f0ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
        }

        .line-btn.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .line-btn.correct {
            border-color: #4caf50;
            background: #4caf50;
            color: white;
        }

        .line-btn.incorrect {
            border-color: #f44336;
            background: #f44336;
            color: white;
        }

        .submit-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .next-btn {
            width: 100%;
            padding: 15px;
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: none;
        }

        .next-btn:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .result-message {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 600;
            display: none;
        }

        .result-message.correct {
            background: #e8f5e9;
            color: #2e7d32;
            border: 2px solid #4caf50;
        }

        .result-message.incorrect {
            background: #ffebee;
            color: #c62828;
            border: 2px solid #f44336;
        }

        .definitions-section {
            background: #f9f9f9;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .definitions-section h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .definition-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .definition-tab {
            padding: 10px 20px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .definition-tab:hover {
            border-color: #667eea;
            background: #f0f0ff;
        }

        .definition-tab.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .definition-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            min-height: 200px;
            white-space: pre-wrap;
            line-height: 1.6;
            display: none;
        }

        .definition-content.active {
            display: block;
        }

        .image-list {
            background: #f9f9f9;
            border-radius: 15px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .image-list h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .image-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .image-item:hover {
            background: #f0f0ff;
            transform: translateX(5px);
        }

        .image-item.active {
            background: #667eea;
            color: white;
        }

        .image-item img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 5px;
            margin-right: 15px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .upload-section {
            background: #f9f9f9;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            display: none;
        }

        .upload-section.active {
            display: block;
        }

        .upload-toggle {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .upload-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px 20px;
            text-align: center;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .upload-area:hover {
            background: #f0f0ff;
            border-color: #764ba2;
        }

        .upload-area.dragover {
            background: #e8e8ff;
            border-color: #4caf50;
        }

        .upload-images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .upload-image-item {
            position: relative;
            border: 2px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            background: white;
        }

        .upload-image-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }

        .upload-image-item .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            cursor: pointer;
            font-size: 0.8em;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .upload-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .btn-upload-small {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-upload-small:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-upload-small:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-clear-small {
            background: #f44336;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-clear-small:hover {
            background: #d32f2f;
            transform: translateY(-2px);
        }

        .upload-progress {
            margin-top: 15px;
            display: none;
        }

        .upload-progress.active {
            display: block;
        }

        .upload-result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }

        .upload-result.success {
            background: #e8f5e9;
            border: 2px solid #4caf50;
            color: #2e7d32;
        }

        .upload-result.error {
            background: #ffebee;
            border: 2px solid #f44336;
            color: #c62828;
        }

        @media (max-width: 768px) {
            .quiz-section {
                grid-template-columns: 1fr;
            }

            .line-buttons {
                grid-template-columns: 1fr;
            }

            .stats-bar {
                flex-direction: column;
                gap: 15px;
            }

            .header-stats {
                position: static;
                margin-bottom: 20px;
                justify-content: center;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <div class="header-stats" onclick="window.location.href='/line-quiz-stats'">
                <div class="header-stat-item">
                    <span class="header-stat-value" id="headerTotal">0</span>
                    <span class="header-stat-label">ì „ì²´ ë¬¸ì œ</span>
                </div>
                <div class="header-stat-item">
                    <span class="header-stat-value" id="headerCorrect">0</span>
                    <span class="header-stat-label">ì •ë‹µ</span>
                </div>
                <div class="header-stat-item">
                    <span class="header-stat-value" id="headerAccuracy">0%</span>
                    <span class="header-stat-label">ì •ë‹µë¥ </span>
                </div>
            </div>
            <h1>ë¼ì¸ í€´ì¦ˆ í…ŒìŠ¤íŠ¸</h1>
            <p>ì²´í˜• ë¼ì¸ì„ ë§ì¶°ë³´ì„¸ìš”!</p>
        </div>

        <div class="content">
            <div class="stats-bar">
                <div class="stat-item">
                    <div class="stat-value" id="totalCount">0</div>
                    <div class="stat-label">ì „ì²´ ë¬¸ì œ</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="currentIndex">0</div>
                    <div class="stat-label">í˜„ì¬ ë¬¸ì œ</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="correctCount">0</div>
                    <div class="stat-label">ì •ë‹µ</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="accuracy">0%</div>
                    <div class="stat-label">ì •ë‹µë¥ </div>
                </div>
            </div>

            <div class="quiz-section">
                <div class="image-section">
                    <h3>ì²´í˜• ì‚¬ì§„</h3>
                    <div id="imageContainer">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                        </div>
                    </div>
                </div>

                <div class="answer-section">
                    <h3>ì–´ë–¤ ë¼ì¸ì¸ê°€ìš”?</h3>
                    <div class="line-buttons">
                        <button class="line-btn" data-line="Aë¼ì¸">Aë¼ì¸</button>
                        <button class="line-btn" data-line="Hë¼ì¸">Hë¼ì¸</button>
                        <button class="line-btn" data-line="Oë¼ì¸">Oë¼ì¸</button>
                        <button class="line-btn" data-line="Xë¼ì¸">Xë¼ì¸</button>
                    </div>
                    <div class="result-message" id="resultMessage"></div>
                    <button class="submit-btn" id="submitBtn" disabled>ì •ë‹µ ì œì¶œ</button>
                    <button class="next-btn" id="nextBtn">ë‹¤ìŒ ë¬¸ì œ</button>
                </div>
            </div>

            <div class="definitions-section">
                <h3>ë¼ì¸ë³„ ì •ì˜</h3>
                <div class="definition-tabs">
                    <div class="definition-tab active" data-line="Aë¼ì¸">Aë¼ì¸</div>
                    <div class="definition-tab" data-line="Hë¼ì¸">Hë¼ì¸</div>
                    <div class="definition-tab" data-line="Oë¼ì¸">Oë¼ì¸</div>
                    <div class="definition-tab" data-line="Xë¼ì¸">Xë¼ì¸</div>
                </div>
                <div id="definitionsContainer">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>ì •ì˜ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        let images = [];
        let definitions = {};
        let currentImageIndex = 0;
        let selectedAnswer = null;
        let correctCount = 0;
        let totalAnswered = 0;

        // DBì—ì„œ ì „ì²´ í†µê³„ ë¡œë“œ (ëª¨ë“  ì‚¬ìš©ì ëˆ„ì )
        async function loadStats() {
            try {
                // DBì—ì„œ ì „ì²´ í†µê³„ ê°€ì ¸ì˜¤ê¸°
                const response = await fetch('/api/line-quiz/results?limit=1');
                const data = await response.json();
                
                if (data.success && data.statistics) {
                    // DB í†µê³„ ì‚¬ìš© (ëª¨ë“  ì‚¬ìš©ì ëˆ„ì )
                    totalAnswered = data.statistics.total || 0;
                    correctCount = data.statistics.correct || 0;
                } else {
                    // DBì— ë°ì´í„°ê°€ ì—†ìœ¼ë©´ localStorageì—ì„œ ê°€ì ¸ì˜¤ê¸° (ëŒ€ì²´)
                    const savedStats = localStorage.getItem('lineQuizStats');
                    if (savedStats) {
                        const stats = JSON.parse(savedStats);
                        correctCount = stats.correctCount || 0;
                        totalAnswered = stats.totalAnswered || 0;
                    }
                }
                
                // ìƒì„¸ ë‹µë³€ ê¸°ë¡ ë¡œë“œ (localStorageëŠ” ë°±ì—…ìš©)
                const savedAnswers = localStorage.getItem('lineQuizAnswers');
                if (!savedAnswers) {
                    localStorage.setItem('lineQuizAnswers', JSON.stringify([]));
                }
                
                // í†µê³„ ì—…ë°ì´íŠ¸
                updateStats();
            } catch (error) {
                console.error('í†µê³„ ë¡œë“œ ì˜¤ë¥˜:', error);
                // ì˜¤ë¥˜ ë°œìƒ ì‹œ localStorageì—ì„œ ê°€ì ¸ì˜¤ê¸°
                const savedStats = localStorage.getItem('lineQuizStats');
                if (savedStats) {
                    const stats = JSON.parse(savedStats);
                    correctCount = stats.correctCount || 0;
                    totalAnswered = stats.totalAnswered || 0;
                }
                updateStats();
            }
        }

        // í†µê³„ë¥¼ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
        function saveStats() {
            localStorage.setItem('lineQuizStats', JSON.stringify({
                correctCount: correctCount,
                totalAnswered: totalAnswered,
                lastUpdated: new Date().toISOString()
            }));
        }

        // ì‚¬ìš©ì ID ìƒì„± ë˜ëŠ” ê°€ì ¸ì˜¤ê¸°
        function getUserId() {
            let userId = sessionStorage.getItem('quizUserId');
            if (!userId) {
                userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                sessionStorage.setItem('quizUserId', userId);
            }
            return userId;
        }

        // ìƒì„¸ ë‹µë³€ ê¸°ë¡ ì €ì¥ (ì—¬ëŸ¬ ì‚¬ëŒì˜ ë°ì´í„° ëˆ„ì )
        function saveAnswer(imagePath, userAnswer, correctAnswer, isCorrect) {
            const answers = JSON.parse(localStorage.getItem('lineQuizAnswers') || '[]');
            const userId = getUserId();
            answers.push({
                user_id: userId,
                image_path: imagePath,
                user_answer: userAnswer,
                correct_answer: correctAnswer,
                is_correct: isCorrect,
                timestamp: new Date().toISOString()
            });
            localStorage.setItem('lineQuizAnswers', JSON.stringify(answers));
        }

        // ì´ë¯¸ì§€ ì…”í”Œ (ëœë¤)
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // ì´ë¯¸ì§€ ë¡œë“œ ì„±ê³µ í•¸ë“¤ëŸ¬
        function handleImageLoad(img, filename) {
            console.log(`[DEBUG] ì´ë¯¸ì§€ ë¡œë“œ ì„±ê³µ: ${filename}`);
        }

        // ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ í•¸ë“¤ëŸ¬
        function handleImageError(img, imageUrl, filename) {
            console.error(`[ERROR] ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨:`, {
                filename: filename,
                image_url: imageUrl,
                error: 'ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
            });
            
            // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
            const container = document.getElementById('imageContainer');
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #f44336;">
                    <p style="font-size: 1.2em; margin-bottom: 10px;">âš ï¸ ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</p>
                    <p style="font-size: 0.9em; color: #666; margin-bottom: 5px;">íŒŒì¼ëª…: ${filename}</p>
                    <p style="font-size: 0.8em; color: #999; word-break: break-all;">URL: ${imageUrl}</p>
                    <p style="font-size: 0.9em; color: #666; margin-top: 20px;">ë‹¤ìŒ ì´ë¯¸ì§€ë¡œ ë„˜ì–´ê°€ê±°ë‚˜ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.</p>
                </div>
            `;
        }

        // ì´ë¯¸ì§€ ë¦¬ìŠ¤íŠ¸ ë¡œë“œ
        async function loadImages() {
            try {
                console.log('[DEBUG] ì´ë¯¸ì§€ ë¡œë“œ ì‹œì‘...');
                const response = await fetch('/api/line-quiz/images');
                const data = await response.json();
                
                console.log('[DEBUG] API ì‘ë‹µ:', {
                    success: data.success,
                    total: data.total,
                    source: data.source,
                    images_count: data.images ? data.images.length : 0
                });
                
                if (data.success) {
                    if (data.images && data.images.length > 0) {
                        images = data.images; // ì…”í”Œí•˜ì§€ ì•ŠìŒ (ëœë¤ ì¸ë±ìŠ¤ë¡œ ì„ íƒ)
                        console.log('[DEBUG] ì´ë¯¸ì§€ ë¡œë“œ ì„±ê³µ:', images.length, 'ê°œ');
                        
                        // ì´ˆê¸° ì´ë¯¸ì§€ë„ ëœë¤ìœ¼ë¡œ ì„ íƒ (ì¤‘ë³µ ì—†ì´)
                        const usedIndices = JSON.parse(sessionStorage.getItem('usedIndices') || '[]');
                        
                        // ëª¨ë“  ì´ë¯¸ì§€ë¥¼ ë‹¤ ë´¤ìœ¼ë©´ í…ŒìŠ¤íŠ¸ ì™„ë£Œ í‘œì‹œ
                        if (usedIndices.length >= images.length) {
                            document.getElementById('imageContainer').innerHTML = `
                                <div style="text-align: center; padding: 40px;">
                                    <h2 style="color: #4CAF50; margin-bottom: 20px;">ğŸ‰ í…ŒìŠ¤íŠ¸ ì™„ë£Œ!</h2>
                                    <p style="font-size: 18px; margin-bottom: 10px;">ëª¨ë“  ${images.length}ê°œì˜ ë¬¸ì œë¥¼ ì™„ë£Œí•˜ì…¨ìŠµë‹ˆë‹¤.</p>
                                    <p style="font-size: 16px; color: #666; margin-bottom: 30px;">í†µê³„ í˜ì´ì§€ì—ì„œ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
                                    <button onclick="window.location.href='/line-quiz-stats'" style="padding: 12px 24px; font-size: 16px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                        í†µê³„ ë³´ê¸°
                                    </button>
                                </div>
                            `;
                            document.getElementById('submitBtn').style.display = 'none';
                            document.querySelectorAll('.line-btn').forEach(btn => btn.style.display = 'none');
                        } else {
                            // ì•„ì§ ì•ˆ ë³¸ ì´ë¯¸ì§€ ì¤‘ì—ì„œ ëœë¤ ì„ íƒ
                            let initialIndex;
                            do {
                                initialIndex = Math.floor(Math.random() * images.length);
                            } while (usedIndices.includes(initialIndex));
                            
                            usedIndices.push(initialIndex);
                            sessionStorage.setItem('usedIndices', JSON.stringify(usedIndices));
                            
                            currentImageIndex = initialIndex;
                            loadCurrentImage();
                        }
                    } else {
                        console.warn('[DEBUG] ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.');
                        document.getElementById('imageContainer').innerHTML = 
                            '<p style="text-align: center; color: #f44336;">ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤. S3ì— ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</p>';
                    }
                } else {
                    console.error('[DEBUG] API ì˜¤ë¥˜:', data.error);
                    document.getElementById('imageContainer').innerHTML = 
                        `<p style="text-align: center; color: #f44336;">ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}</p>`;
                }
            } catch (error) {
                console.error('[DEBUG] ì´ë¯¸ì§€ ë¡œë“œ ì˜¤ë¥˜:', error);
                document.getElementById('imageContainer').innerHTML = 
                    `<p style="text-align: center; color: #f44336;">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}</p>`;
            }
        }

        // ë¼ì¸ ì •ì˜ ë¡œë“œ
        async function loadDefinitions() {
            try {
                const response = await fetch('/api/line-quiz/definitions');
                const data = await response.json();
                
                if (data.success) {
                    definitions = data.definitions;
                    displayDefinitions();
                } else {
                    document.getElementById('definitionsContainer').innerHTML = 
                        '<p style="text-align: center; color: #f44336;">ì •ì˜ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
                }
            } catch (error) {
                console.error('ì •ì˜ ë¡œë“œ ì˜¤ë¥˜:', error);
                document.getElementById('definitionsContainer').innerHTML = 
                    '<p style="text-align: center; color: #f44336;">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
            }
        }


        // í˜„ì¬ ì´ë¯¸ì§€ ë¡œë“œ
        function loadCurrentImage() {
            if (images.length === 0) return;
            
            const currentImage = images[currentImageIndex];
            const container = document.getElementById('imageContainer');
            
            // ì´ë¯¸ì§€ URL ë””ë²„ê¹…
            console.log(`[DEBUG] ì´ë¯¸ì§€ ë¡œë“œ ì‹œë„:`, {
                filename: currentImage.filename,
                image_url: currentImage.image_url,
                image_path: currentImage.image_path,
                line_type: currentImage.line_type
            });
            
            container.innerHTML = `
                <img src="${currentImage.image_url}" 
                     alt="${currentImage.filename}" 
                     class="quiz-image"
                     onerror="handleImageError(this, '${currentImage.image_url}', '${currentImage.filename}')"
                     onload="handleImageLoad(this, '${currentImage.filename}')">
            `;
            
            // ìƒíƒœ ì´ˆê¸°í™”
            selectedAnswer = null;
            document.querySelectorAll('.line-btn').forEach(btn => {
                btn.classList.remove('selected', 'correct', 'incorrect');
            });
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('nextBtn').style.display = 'none';
            document.getElementById('resultMessage').style.display = 'none';
            
            // í…ŒìŠ¤íŠ¸ ì™„ë£Œ ì—¬ë¶€ í™•ì¸
            const usedIndices = JSON.parse(sessionStorage.getItem('usedIndices') || '[]');
            if (usedIndices.length >= images.length) {
                document.getElementById('nextBtn').style.display = 'none';
            }
            
            updateStats();
        }

        // ë¼ì¸ ì •ì˜ í‘œì‹œ
        function displayDefinitions() {
            const container = document.getElementById('definitionsContainer');
            container.innerHTML = '';
            
            const lines = ['Aë¼ì¸', 'Hë¼ì¸', 'Oë¼ì¸', 'Xë¼ì¸'];
            lines.forEach((line, index) => {
                const content = document.createElement('div');
                content.className = 'definition-content';
                if (index === 0) content.classList.add('active');
                content.textContent = definitions[line] || 'ì •ì˜ê°€ ì—†ìŠµë‹ˆë‹¤.';
                container.appendChild(content);
            });
            
            // íƒ­ í´ë¦­ ì´ë²¤íŠ¸
            document.querySelectorAll('.definition-tab').forEach((tab, index) => {
                tab.onclick = () => {
                    document.querySelectorAll('.definition-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.definition-content').forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    document.querySelectorAll('.definition-content')[index].classList.add('active');
                };
            });
        }

        // ë¼ì¸ ë²„íŠ¼ í´ë¦­
        document.querySelectorAll('.line-btn').forEach(btn => {
            btn.onclick = () => {
                if (document.getElementById('nextBtn').style.display === 'block') return;
                
                document.querySelectorAll('.line-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                selectedAnswer = btn.dataset.line;
                document.getElementById('submitBtn').disabled = false;
            };
        });

        // ì •ë‹µ ì œì¶œ (ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ + DB ì €ì¥)
        document.getElementById('submitBtn').onclick = async () => {
            if (!selectedAnswer || images.length === 0) return;
            
            const currentImage = images[currentImageIndex];
            const isCorrect = selectedAnswer === currentImage.line_type;
            
            // ê²°ê³¼ í‘œì‹œ
            const resultMessage = document.getElementById('resultMessage');
            resultMessage.textContent = isCorrect ? 'ì •ë‹µì…ë‹ˆë‹¤!' : `í‹€ë ¸ìŠµë‹ˆë‹¤. ì •ë‹µì€ ${currentImage.line_type}ì…ë‹ˆë‹¤.`;
            resultMessage.className = 'result-message ' + (isCorrect ? 'correct' : 'incorrect');
            resultMessage.style.display = 'block';
            
            // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.line-btn').forEach(btn => {
                if (btn.dataset.line === currentImage.line_type) {
                    btn.classList.add('correct');
                }
                if (btn.dataset.line === selectedAnswer && !isCorrect) {
                    btn.classList.add('incorrect');
                }
            });
            
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('nextBtn').style.display = 'block';
            
            // localStorageëŠ” ë°±ì—…ìš©ìœ¼ë¡œë§Œ ì €ì¥
            saveStats();
            saveAnswer(currentImage.image_path, selectedAnswer, currentImage.line_type, isCorrect);
            
            // DBì— ì €ì¥
            try {
                const userId = getUserId();
                const response = await fetch('/api/line-quiz/submit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        image_path: currentImage.image_path,
                        image_url: currentImage.image_url,
                        user_answer: selectedAnswer,
                        correct_answer: currentImage.line_type,
                        user_id: userId,
                        user_name: userId
                    })
                });
                
                const data = await response.json();
                
                // DB ì €ì¥ í›„ ì „ì²´ í†µê³„ ë‹¤ì‹œ ë¡œë“œ (ëª¨ë“  ì‚¬ìš©ì ëˆ„ì )
                if (response.ok && data.success) {
                    await loadStats(); // DBì—ì„œ ìµœì‹  í†µê³„ ê°€ì ¸ì˜¤ê¸° (ëª¨ë“  ì‚¬ìš©ì ëˆ„ì )
                } else {
                    console.warn('DB ì €ì¥ ì‹¤íŒ¨:', data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
                    // DB ì €ì¥ ì‹¤íŒ¨ ì‹œì—ë„ ë¡œì»¬ í†µê³„ ì—…ë°ì´íŠ¸ (ì„ì‹œ)
                    totalAnswered++;
                    if (isCorrect) correctCount++;
                    updateStats();
                }
            } catch (error) {
                console.error('DB ì €ì¥ ì˜¤ë¥˜:', error);
                // DB ì €ì¥ ì‹¤íŒ¨í•´ë„ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ëŠ” ì €ì¥ë˜ë¯€ë¡œ ê³„ì† ì§„í–‰
            }
        };

        // ë‹¤ìŒ ë¬¸ì œ (ëœë¤, ì¤‘ë³µ ì—†ì´)
        document.getElementById('nextBtn').onclick = () => {
            // ì´ë¯¸ ë³¸ ì´ë¯¸ì§€ ì œì™¸í•˜ê³  ëœë¤ ì„ íƒ
            const usedIndices = JSON.parse(sessionStorage.getItem('usedIndices') || '[]');
            
            // ëª¨ë“  ì´ë¯¸ì§€ë¥¼ ë‹¤ ë´¤ìœ¼ë©´ (80ë²ˆ ì™„ë£Œ) í…ŒìŠ¤íŠ¸ ì¢…ë£Œ
            if (usedIndices.length >= images.length) {
                // í…ŒìŠ¤íŠ¸ ì™„ë£Œ ë©”ì‹œì§€ í‘œì‹œ
                document.getElementById('imageContainer').innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <h2 style="color: #4CAF50; margin-bottom: 20px;">ğŸ‰ í…ŒìŠ¤íŠ¸ ì™„ë£Œ!</h2>
                        <p style="font-size: 18px; margin-bottom: 10px;">ëª¨ë“  ${images.length}ê°œì˜ ë¬¸ì œë¥¼ ì™„ë£Œí•˜ì…¨ìŠµë‹ˆë‹¤.</p>
                        <p style="font-size: 16px; color: #666; margin-bottom: 30px;">í†µê³„ í˜ì´ì§€ì—ì„œ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
                        <button onclick="window.location.href='/line-quiz-stats'" style="padding: 12px 24px; font-size: 16px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            í†µê³„ ë³´ê¸°
                        </button>
                    </div>
                `;
                document.getElementById('nextBtn').style.display = 'none';
                document.getElementById('submitBtn').style.display = 'none';
                document.querySelectorAll('.line-btn').forEach(btn => btn.style.display = 'none');
                return;
            }
            
            // ì•„ì§ ì•ˆ ë³¸ ì´ë¯¸ì§€ ì¤‘ì—ì„œ ëœë¤ ì„ íƒ
            let nextIndex;
            do {
                nextIndex = Math.floor(Math.random() * images.length);
            } while (usedIndices.includes(nextIndex));
            
            usedIndices.push(nextIndex);
            sessionStorage.setItem('usedIndices', JSON.stringify(usedIndices));
            
            currentImageIndex = nextIndex;
            loadCurrentImage();
        };

        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStats() {
            const usedIndices = JSON.parse(sessionStorage.getItem('usedIndices') || '[]');
            const completedCount = usedIndices.length;
            
            document.getElementById('totalCount').textContent = images.length;
            document.getElementById('currentIndex').textContent = `${completedCount}/${images.length}`;
            document.getElementById('correctCount').textContent = correctCount;
            const accuracy = totalAnswered > 0 ? Math.round((correctCount / totalAnswered) * 100) : 0;
            document.getElementById('accuracy').textContent = accuracy + '%';
            
            // í—¤ë” í†µê³„ ì—…ë°ì´íŠ¸
            document.getElementById('headerTotal').textContent = totalAnswered;
            document.getElementById('headerCorrect').textContent = correctCount;
            document.getElementById('headerAccuracy').textContent = accuracy + '%';
        }

        // ì´ˆê¸°í™”
        (async () => {
            await loadStats();
            loadImages();
            loadDefinitions();
        })();
    </script>
</body>

</html>


