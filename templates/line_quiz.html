<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>라인 퀴즈 테스트 - Marryday</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .header-stats {
            position: absolute;
            top: 20px;
            right: 30px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px 25px;
            display: flex;
            gap: 30px;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .header-stats:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .header-stat-item {
            text-align: center;
        }

        .header-stat-value {
            font-size: 1.8em;
            font-weight: bold;
            display: block;
        }

        .header-stat-label {
            font-size: 0.85em;
            opacity: 0.9;
            margin-top: 5px;
        }

        .content {
            padding: 30px;
        }

        .stats-bar {
            display: flex;
            justify-content: space-around;
            background: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        .quiz-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .image-section {
            background: #f9f9f9;
            border-radius: 15px;
            padding: 20px;
        }

        .image-section h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .quiz-image {
            width: 100%;
            max-height: 500px;
            object-fit: contain;
            border-radius: 10px;
            background: white;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 15px;
        }

        .answer-section {
            background: #f9f9f9;
            border-radius: 15px;
            padding: 20px;
        }

        .answer-section h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .line-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .line-btn {
            padding: 20px;
            border: 3px solid #ddd;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
        }

        .line-btn:hover {
            border-color: #667eea;
            background: #f0f0ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
        }

        .line-btn.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .line-btn.correct {
            border-color: #4caf50;
            background: #4caf50;
            color: white;
        }

        .line-btn.incorrect {
            border-color: #f44336;
            background: #f44336;
            color: white;
        }

        .submit-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .next-btn {
            width: 100%;
            padding: 15px;
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: none;
        }

        .next-btn:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .result-message {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 600;
            display: none;
        }

        .result-message.correct {
            background: #e8f5e9;
            color: #2e7d32;
            border: 2px solid #4caf50;
        }

        .result-message.incorrect {
            background: #ffebee;
            color: #c62828;
            border: 2px solid #f44336;
        }

        .definitions-section {
            background: #f9f9f9;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .definitions-section h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .definition-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .definition-tab {
            padding: 10px 20px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .definition-tab:hover {
            border-color: #667eea;
            background: #f0f0ff;
        }

        .definition-tab.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .definition-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            min-height: 200px;
            white-space: pre-wrap;
            line-height: 1.6;
            display: none;
        }

        .definition-content.active {
            display: block;
        }

        .image-list {
            background: #f9f9f9;
            border-radius: 15px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .image-list h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .image-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .image-item:hover {
            background: #f0f0ff;
            transform: translateX(5px);
        }

        .image-item.active {
            background: #667eea;
            color: white;
        }

        .image-item img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 5px;
            margin-right: 15px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .upload-section {
            background: #f9f9f9;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            display: none;
        }

        .upload-section.active {
            display: block;
        }

        .upload-toggle {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .upload-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px 20px;
            text-align: center;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .upload-area:hover {
            background: #f0f0ff;
            border-color: #764ba2;
        }

        .upload-area.dragover {
            background: #e8e8ff;
            border-color: #4caf50;
        }

        .upload-images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .upload-image-item {
            position: relative;
            border: 2px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            background: white;
        }

        .upload-image-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }

        .upload-image-item .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            cursor: pointer;
            font-size: 0.8em;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .upload-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .btn-upload-small {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-upload-small:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-upload-small:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-clear-small {
            background: #f44336;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-clear-small:hover {
            background: #d32f2f;
            transform: translateY(-2px);
        }

        .upload-progress {
            margin-top: 15px;
            display: none;
        }

        .upload-progress.active {
            display: block;
        }

        .upload-result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }

        .upload-result.success {
            background: #e8f5e9;
            border: 2px solid #4caf50;
            color: #2e7d32;
        }

        .upload-result.error {
            background: #ffebee;
            border: 2px solid #f44336;
            color: #c62828;
        }

        @media (max-width: 768px) {
            .quiz-section {
                grid-template-columns: 1fr;
            }

            .line-buttons {
                grid-template-columns: 1fr;
            }

            .stats-bar {
                flex-direction: column;
                gap: 15px;
            }

            .header-stats {
                position: static;
                margin-bottom: 20px;
                justify-content: center;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <div class="header-stats" onclick="window.location.href='/line-quiz-stats'">
                <div class="header-stat-item">
                    <span class="header-stat-value" id="headerTotal">0</span>
                    <span class="header-stat-label">전체 문제</span>
                </div>
                <div class="header-stat-item">
                    <span class="header-stat-value" id="headerCorrect">0</span>
                    <span class="header-stat-label">정답</span>
                </div>
                <div class="header-stat-item">
                    <span class="header-stat-value" id="headerAccuracy">0%</span>
                    <span class="header-stat-label">정답률</span>
                </div>
            </div>
            <h1>라인 퀴즈 테스트</h1>
            <p>체형 라인을 맞춰보세요!</p>
        </div>

        <div class="content">
            <div class="stats-bar">
                <div class="stat-item">
                    <div class="stat-value" id="totalCount">0</div>
                    <div class="stat-label">전체 문제</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="currentIndex">0</div>
                    <div class="stat-label">현재 문제</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="correctCount">0</div>
                    <div class="stat-label">정답</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="accuracy">0%</div>
                    <div class="stat-label">정답률</div>
                </div>
            </div>

            <div class="quiz-section">
                <div class="image-section">
                    <h3>체형 사진</h3>
                    <div id="imageContainer">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>이미지를 불러오는 중...</p>
                        </div>
                    </div>
                </div>

                <div class="answer-section">
                    <h3>어떤 라인인가요?</h3>
                    <div class="line-buttons">
                        <button class="line-btn" data-line="A라인">A라인</button>
                        <button class="line-btn" data-line="H라인">H라인</button>
                        <button class="line-btn" data-line="O라인">O라인</button>
                        <button class="line-btn" data-line="X라인">X라인</button>
                    </div>
                    <div class="result-message" id="resultMessage"></div>
                    <button class="submit-btn" id="submitBtn" disabled>정답 제출</button>
                    <button class="next-btn" id="nextBtn">다음 문제</button>
                </div>
            </div>

            <div class="definitions-section">
                <h3>라인별 정의</h3>
                <div class="definition-tabs">
                    <div class="definition-tab active" data-line="A라인">A라인</div>
                    <div class="definition-tab" data-line="H라인">H라인</div>
                    <div class="definition-tab" data-line="O라인">O라인</div>
                    <div class="definition-tab" data-line="X라인">X라인</div>
                </div>
                <div id="definitionsContainer">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>정의를 불러오는 중...</p>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        let images = [];
        let definitions = {};
        let currentImageIndex = 0;
        let selectedAnswer = null;
        let correctCount = 0;
        let totalAnswered = 0;

        // DB에서 전체 통계 로드 (모든 사용자 누적)
        async function loadStats() {
            try {
                // DB에서 전체 통계 가져오기
                const response = await fetch('/api/line-quiz/results?limit=1');
                const data = await response.json();
                
                if (data.success && data.statistics) {
                    // DB 통계 사용 (모든 사용자 누적)
                    totalAnswered = data.statistics.total || 0;
                    correctCount = data.statistics.correct || 0;
                } else {
                    // DB에 데이터가 없으면 localStorage에서 가져오기 (대체)
                    const savedStats = localStorage.getItem('lineQuizStats');
                    if (savedStats) {
                        const stats = JSON.parse(savedStats);
                        correctCount = stats.correctCount || 0;
                        totalAnswered = stats.totalAnswered || 0;
                    }
                }
                
                // 상세 답변 기록 로드 (localStorage는 백업용)
                const savedAnswers = localStorage.getItem('lineQuizAnswers');
                if (!savedAnswers) {
                    localStorage.setItem('lineQuizAnswers', JSON.stringify([]));
                }
                
                // 통계 업데이트
                updateStats();
            } catch (error) {
                console.error('통계 로드 오류:', error);
                // 오류 발생 시 localStorage에서 가져오기
                const savedStats = localStorage.getItem('lineQuizStats');
                if (savedStats) {
                    const stats = JSON.parse(savedStats);
                    correctCount = stats.correctCount || 0;
                    totalAnswered = stats.totalAnswered || 0;
                }
                updateStats();
            }
        }

        // 통계를 로컬 스토리지에 저장
        function saveStats() {
            localStorage.setItem('lineQuizStats', JSON.stringify({
                correctCount: correctCount,
                totalAnswered: totalAnswered,
                lastUpdated: new Date().toISOString()
            }));
        }

        // 사용자 ID 생성 또는 가져오기
        function getUserId() {
            let userId = sessionStorage.getItem('quizUserId');
            if (!userId) {
                userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                sessionStorage.setItem('quizUserId', userId);
            }
            return userId;
        }

        // 상세 답변 기록 저장 (여러 사람의 데이터 누적)
        function saveAnswer(imagePath, userAnswer, correctAnswer, isCorrect) {
            const answers = JSON.parse(localStorage.getItem('lineQuizAnswers') || '[]');
            const userId = getUserId();
            answers.push({
                user_id: userId,
                image_path: imagePath,
                user_answer: userAnswer,
                correct_answer: correctAnswer,
                is_correct: isCorrect,
                timestamp: new Date().toISOString()
            });
            localStorage.setItem('lineQuizAnswers', JSON.stringify(answers));
        }

        // 이미지 셔플 (랜덤)
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // 이미지 로드 성공 핸들러
        function handleImageLoad(img, filename) {
            console.log(`[DEBUG] 이미지 로드 성공: ${filename}`);
        }

        // 이미지 로드 실패 핸들러
        function handleImageError(img, imageUrl, filename) {
            console.error(`[ERROR] 이미지 로드 실패:`, {
                filename: filename,
                image_url: imageUrl,
                error: '이미지를 불러올 수 없습니다.'
            });
            
            // 에러 메시지 표시
            const container = document.getElementById('imageContainer');
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #f44336;">
                    <p style="font-size: 1.2em; margin-bottom: 10px;">⚠️ 이미지를 불러올 수 없습니다</p>
                    <p style="font-size: 0.9em; color: #666; margin-bottom: 5px;">파일명: ${filename}</p>
                    <p style="font-size: 0.8em; color: #999; word-break: break-all;">URL: ${imageUrl}</p>
                    <p style="font-size: 0.9em; color: #666; margin-top: 20px;">다음 이미지로 넘어가거나 페이지를 새로고침해주세요.</p>
                </div>
            `;
        }

        // 이미지 리스트 로드
        async function loadImages() {
            try {
                console.log('[DEBUG] 이미지 로드 시작...');
                const response = await fetch('/api/line-quiz/images');
                const data = await response.json();
                
                console.log('[DEBUG] API 응답:', {
                    success: data.success,
                    total: data.total,
                    source: data.source,
                    images_count: data.images ? data.images.length : 0
                });
                
                if (data.success) {
                    if (data.images && data.images.length > 0) {
                        images = shuffleArray(data.images); // 랜덤 셔플
                        console.log('[DEBUG] 이미지 로드 성공:', images.length, '개');
                        loadCurrentImage();
                    } else {
                        console.warn('[DEBUG] 이미지가 없습니다.');
                        document.getElementById('imageContainer').innerHTML = 
                            '<p style="text-align: center; color: #f44336;">이미지가 없습니다. S3에 이미지를 업로드해주세요.</p>';
                    }
                } else {
                    console.error('[DEBUG] API 오류:', data.error);
                    document.getElementById('imageContainer').innerHTML = 
                        `<p style="text-align: center; color: #f44336;">이미지를 불러올 수 없습니다: ${data.error || '알 수 없는 오류'}</p>`;
                }
            } catch (error) {
                console.error('[DEBUG] 이미지 로드 오류:', error);
                document.getElementById('imageContainer').innerHTML = 
                    `<p style="text-align: center; color: #f44336;">오류가 발생했습니다: ${error.message}</p>`;
            }
        }

        // 라인 정의 로드
        async function loadDefinitions() {
            try {
                const response = await fetch('/api/line-quiz/definitions');
                const data = await response.json();
                
                if (data.success) {
                    definitions = data.definitions;
                    displayDefinitions();
                } else {
                    document.getElementById('definitionsContainer').innerHTML = 
                        '<p style="text-align: center; color: #f44336;">정의를 불러올 수 없습니다.</p>';
                }
            } catch (error) {
                console.error('정의 로드 오류:', error);
                document.getElementById('definitionsContainer').innerHTML = 
                    '<p style="text-align: center; color: #f44336;">오류가 발생했습니다.</p>';
            }
        }


        // 현재 이미지 로드
        function loadCurrentImage() {
            if (images.length === 0) return;
            
            const currentImage = images[currentImageIndex];
            const container = document.getElementById('imageContainer');
            
            // 이미지 URL 디버깅
            console.log(`[DEBUG] 이미지 로드 시도:`, {
                filename: currentImage.filename,
                image_url: currentImage.image_url,
                image_path: currentImage.image_path,
                line_type: currentImage.line_type
            });
            
            container.innerHTML = `
                <img src="${currentImage.image_url}" 
                     alt="${currentImage.filename}" 
                     class="quiz-image"
                     onerror="handleImageError(this, '${currentImage.image_url}', '${currentImage.filename}')"
                     onload="handleImageLoad(this, '${currentImage.filename}')">
            `;
            
            // 상태 초기화
            selectedAnswer = null;
            document.querySelectorAll('.line-btn').forEach(btn => {
                btn.classList.remove('selected', 'correct', 'incorrect');
            });
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('nextBtn').style.display = 'none';
            document.getElementById('resultMessage').style.display = 'none';
            
            updateStats();
        }

        // 라인 정의 표시
        function displayDefinitions() {
            const container = document.getElementById('definitionsContainer');
            container.innerHTML = '';
            
            const lines = ['A라인', 'H라인', 'O라인', 'X라인'];
            lines.forEach((line, index) => {
                const content = document.createElement('div');
                content.className = 'definition-content';
                if (index === 0) content.classList.add('active');
                content.textContent = definitions[line] || '정의가 없습니다.';
                container.appendChild(content);
            });
            
            // 탭 클릭 이벤트
            document.querySelectorAll('.definition-tab').forEach((tab, index) => {
                tab.onclick = () => {
                    document.querySelectorAll('.definition-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.definition-content').forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    document.querySelectorAll('.definition-content')[index].classList.add('active');
                };
            });
        }

        // 라인 버튼 클릭
        document.querySelectorAll('.line-btn').forEach(btn => {
            btn.onclick = () => {
                if (document.getElementById('nextBtn').style.display === 'block') return;
                
                document.querySelectorAll('.line-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                selectedAnswer = btn.dataset.line;
                document.getElementById('submitBtn').disabled = false;
            };
        });

        // 정답 제출 (로컬 스토리지 + DB 저장)
        document.getElementById('submitBtn').onclick = async () => {
            if (!selectedAnswer || images.length === 0) return;
            
            const currentImage = images[currentImageIndex];
            const isCorrect = selectedAnswer === currentImage.line_type;
            
            // 결과 표시
            const resultMessage = document.getElementById('resultMessage');
            resultMessage.textContent = isCorrect ? '정답입니다!' : `틀렸습니다. 정답은 ${currentImage.line_type}입니다.`;
            resultMessage.className = 'result-message ' + (isCorrect ? 'correct' : 'incorrect');
            resultMessage.style.display = 'block';
            
            // 버튼 상태 업데이트
            document.querySelectorAll('.line-btn').forEach(btn => {
                if (btn.dataset.line === currentImage.line_type) {
                    btn.classList.add('correct');
                }
                if (btn.dataset.line === selectedAnswer && !isCorrect) {
                    btn.classList.add('incorrect');
                }
            });
            
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('nextBtn').style.display = 'block';
            
            // localStorage는 백업용으로만 저장
            saveStats();
            saveAnswer(currentImage.image_path, selectedAnswer, currentImage.line_type, isCorrect);
            
            // DB에 저장
            try {
                const userId = getUserId();
                const response = await fetch('/api/line-quiz/submit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        image_path: currentImage.image_path,
                        image_url: currentImage.image_url,
                        user_answer: selectedAnswer,
                        correct_answer: currentImage.line_type,
                        user_id: userId,
                        user_name: userId
                    })
                });
                
                const data = await response.json();
                
                // DB 저장 후 전체 통계 다시 로드 (모든 사용자 누적)
                if (response.ok && data.success) {
                    await loadStats(); // DB에서 최신 통계 가져오기 (모든 사용자 누적)
                } else {
                    console.warn('DB 저장 실패:', data.error || '알 수 없는 오류');
                    // DB 저장 실패 시에도 로컬 통계 업데이트 (임시)
                    totalAnswered++;
                    if (isCorrect) correctCount++;
                    updateStats();
                }
            } catch (error) {
                console.error('DB 저장 오류:', error);
                // DB 저장 실패해도 로컬 스토리지는 저장되므로 계속 진행
            }
        };

        // 다음 문제 (랜덤)
        document.getElementById('nextBtn').onclick = () => {
            // 이미 본 이미지 제외하고 랜덤 선택
            const usedIndices = JSON.parse(sessionStorage.getItem('usedIndices') || '[]');
            
            if (usedIndices.length >= images.length) {
                // 모든 이미지를 봤으면 초기화
                sessionStorage.setItem('usedIndices', JSON.stringify([]));
                usedIndices.length = 0;
            }
            
            let nextIndex;
            do {
                nextIndex = Math.floor(Math.random() * images.length);
            } while (usedIndices.includes(nextIndex));
            
            usedIndices.push(nextIndex);
            sessionStorage.setItem('usedIndices', JSON.stringify(usedIndices));
            
            currentImageIndex = nextIndex;
            loadCurrentImage();
        };

        // 통계 업데이트
        function updateStats() {
            document.getElementById('totalCount').textContent = images.length;
            document.getElementById('currentIndex').textContent = currentImageIndex + 1;
            document.getElementById('correctCount').textContent = correctCount;
            const accuracy = totalAnswered > 0 ? Math.round((correctCount / totalAnswered) * 100) : 0;
            document.getElementById('accuracy').textContent = accuracy + '%';
            
            // 헤더 통계 업데이트
            document.getElementById('headerTotal').textContent = totalAnswered;
            document.getElementById('headerCorrect').textContent = correctCount;
            document.getElementById('headerAccuracy').textContent = accuracy + '%';
        }

        // 초기화
        (async () => {
            await loadStats();
            loadImages();
            loadDefinitions();
        })();
    </script>
</body>

</html>


